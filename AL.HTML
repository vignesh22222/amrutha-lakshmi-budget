<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Amrutha Lakshmi Enclave â€“ Budget Summary</title>

<!-- jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

<style>
body{font-family:system-ui;margin:0;background:#f4fffb}
header{background:#0fb7a5;color:#fff;padding:14px;text-align:center;font-weight:700}
.container{padding:12px}
.card{background:#fff;padding:12px;margin-bottom:12px;border-radius:12px}
button{padding:8px 12px;border:none;border-radius:8px;background:#0fb7a5;color:#fff}
button.danger{background:#ef4444}
input,select{width:100%;padding:8px;margin:4px 0}
table{width:100%;border-collapse:collapse;margin-top:8px}
th,td{border:1px solid #ccc;padding:6px;font-size:13px}
.flex{display:flex;gap:8px;flex-wrap:wrap}
.hidden{display:none}
.lock{position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center}
.lock-card{background:#fff;padding:20px;border-radius:12px;width:280px}
</style>
</head>

<body>
<header>AMRUTHA LAKSHMI ENCLAVE â€“ BUDGET SUMMARY</header>

<!-- LOCK -->
<div id="lock" class="lock">
  <div class="lock-card">
    <h3>ğŸ” Enter PIN</h3>
    <input type="password" id="pinInput">
    <button onclick="unlock()">Unlock</button>
    <p id="lockMsg"></p>
  </div>
</div>

<div class="container">

<div id="home" class="hidden">
  <div class="flex">
    <button onclick="addEntry()">â• Add Entry</button>
    <button onclick="exportAll()">ğŸ“¤ Export All</button>
    <button onclick="resetPin()">ğŸ” Reset PIN</button>
  </div>
  <div id="entryList"></div>
</div>

<div id="entryPage" class="hidden"></div>

</div>

<script>
const { jsPDF } = window.jspdf;
const KEY="ALE_BUDGET_FINAL_V2";

/* ---------- HELPERS ---------- */
function rs(n){
  return "Rs. " + String(Math.round(Number(n||0)));
}

/* ---------- DATA ---------- */
let db = JSON.parse(localStorage.getItem(KEY)) || {
  pin:"0000",
  entries:[]
};
let current=null;
function save(){localStorage.setItem(KEY,JSON.stringify(db));}

/* ---------- TOTAL CALCULATIONS ---------- */
function getGrandTotal(){
  let total = 0;
  db.entries.forEach(e=>{
    e.items.forEach(it=>{
      total += Number(it.amount || 0);
    });
  });
  return total;
}

function getMonthWiseTotals(){
  const map = {};
  db.entries.forEach(e=>{
    if(!e.date) return;
    const d = new Date(e.date);
    const key = d.toLocaleString("en-IN",{month:"long",year:"numeric"});
    if(!map[key]) map[key] = 0;
    e.items.forEach(it=>{
      map[key] += Number(it.amount || 0);
    });
  });
  return map;
}

/* ---------- LOCK ---------- */
function unlock(){
  if(pinInput.value===db.pin){
    lock.style.display="none";
    home.classList.remove("hidden");
    renderHome();
  } else lockMsg.textContent="Wrong PIN";
}
function resetPin(){
  const p=prompt("Enter new PIN (min 3 chars)");
  if(p && p.length>=3){db.pin=p;save();alert("PIN Updated")}
}

/* ---------- HOME ---------- */
function renderHome(){
  home.classList.remove("hidden");
  entryPage.classList.add("hidden");

  const grandTotal = getGrandTotal();
  const monthTotals = getMonthWiseTotals();

  let monthRows = "";
  Object.keys(monthTotals).forEach(m=>{
    monthRows += `<tr><td>${m}</td><td>${rs(monthTotals[m])}</td></tr>`;
  });

  entryList.innerHTML = `
    <div class="card">
      <h3>ğŸ“Š Overall Summary</h3>
      <p><b>Total Entries Amount:</b> ${rs(grandTotal)}</p>
    </div>

    <div class="card">
      <h3>ğŸ“… Month-wise Summary</h3>
      <table>
        <tr><th>Month</th><th>Total Amount</th></tr>
        ${monthRows || `<tr><td colspan="2">No data</td></tr>`}
      </table>
    </div>
  `;

  db.entries.forEach((e,i)=>{
    entryList.innerHTML += `
      <div class="card">
        <b>Entry ${i+1}</b> | ${e.date}
        <div class="flex">
          <button onclick="openEntry(${i})">Open</button>
          <button class="danger" onclick="deleteEntry(${i})">Delete</button>
        </div>
      </div>`;
  });
}

function addEntry(){
  db.entries.push({
    date:new Date().toISOString().slice(0,10),
    items:[],
    settlement:[
      {name:"K. VIGNESH",paid:false},
      {name:"A. PRADEEP REDDY",paid:false}
    ]
  });
  save();renderHome();
}
function deleteEntry(i){
  if(confirm("Delete this entry?")){
    db.entries.splice(i,1);save();renderHome();
  }
}

/* ---------- ENTRY ---------- */
function openEntry(i){
  current=i;
  home.classList.add("hidden");
  entryPage.classList.remove("hidden");
  renderEntry();
}

function renderEntry(){
  const e=db.entries[current];
  const total=e.items.reduce((s,x)=>s+Number(x.amount||0),0);

  entryPage.innerHTML=`
  <div class="card">
    <h3>Entry ${current+1}</h3>
    <input type="date" value="${e.date}" onchange="eDate(this.value)">

    <table>
      <tr><th>S.NO</th><th>Paid For</th><th>Amount</th></tr>
      ${e.items.map((it,i)=>`
      <tr>
        <td>${i+1}</td>
        <td><input value="${it.paidFor||''}" oninput="eName(${i},this.value)"></td>
        <td><input type="number" value="${it.amount||''}" oninput="eAmt(${i},this.value)"></td>
      </tr>`).join("")}
    </table>

    <button onclick="addRow()">â• Add Row</button>
    <p><b>Total:</b> ${rs(total)}</p>

    <h4>Settlement</h4>
    <table>
      <tr><th>Name</th><th>Amount</th><th>Status</th></tr>
      ${e.settlement.map(s=>`
      <tr>
        <td>${s.name}</td>
        <td>${rs(total/2)}</td>
        <td>
          <select onchange="sPaid('${s.name}',this.value)">
            <option ${!s.paid?"selected":""}>Not Paid</option>
            <option ${s.paid?"selected":""}>Paid</option>
          </select>
        </td>
      </tr>`).join("")}
    </table>

    <div class="flex">
      <button onclick="saveEntry()">ğŸ’¾ Save</button>
      <button onclick="downloadPDF()">â¬‡ PDF</button>
      <button onclick="renderHome()">â¬… Back</button>
    </div>
  </div>`;
}

function addRow(){
  db.entries[current].items.push({paidFor:"",amount:""});
  save();renderEntry();
}
function eName(i,v){db.entries[current].items[i].paidFor=v;save()}
function eAmt(i,v){db.entries[current].items[i].amount=v;save()}
function eDate(v){db.entries[current].date=v;save()}
function sPaid(n,v){
  db.entries[current].settlement.find(x=>x.name===n).paid=(v==="Paid");
  save();
}
function saveEntry(){alert("Entry Saved");renderHome()}

/* ---------- PDF ---------- */
function downloadPDF(){
  const e=db.entries[current];
  const doc=new jsPDF();

  doc.text("AMRUTHA LAKSHMI ENCLAVE â€“ BUDGET SUMMARY",10,10);
  doc.text(`Entry ${current+1} | Date: ${e.date}`,10,18);

  doc.autoTable({
    startY:25,
    head:[["S.NO","Paid For","Amount"]],
    body:e.items.map((it,i)=>[i+1,it.paidFor,rs(it.amount)])
  });

  const total=e.items.reduce((s,x)=>s+Number(x.amount||0),0);
  doc.text("TOTAL AMOUNT : " + rs(total),14,doc.lastAutoTable.finalY+10);

  doc.autoTable({
    startY:doc.lastAutoTable.finalY+20,
    head:[["Name","Amount","Status"]],
    body:e.settlement.map(s=>[s.name,rs(total/2),s.paid?"Paid":"Not Paid"])
  });

  window.open(doc.output("bloburl"),"_blank");
}

function exportAll(){
  const doc=new jsPDF();
  db.entries.forEach((e,i)=>{
    if(i>0) doc.addPage();
    doc.text("AMRUTHA LAKSHMI ENCLAVE â€“ BUDGET SUMMARY",10,10);
    doc.text(`Entry ${i+1} | Date: ${e.date}`,10,18);
    doc.autoTable({
      startY:25,
      head:[["S.NO","Paid For","Amount"]],
      body:e.items.map((it,j)=>[j+1,it.paidFor,rs(it.amount)])
    });
    const total=e.items.reduce((s,x)=>s+Number(x.amount||0),0);
    doc.text("TOTAL AMOUNT : " + rs(total),14,doc.lastAutoTable.finalY+10);
  });
  window.open(doc.output("bloburl"),"_blank");
}
</script>

</body>
</html>
