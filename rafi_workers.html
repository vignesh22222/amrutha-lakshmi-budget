<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Rafi Workers</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

<style>
body{margin:0;font-family:system-ui;background:#f4fffb}
header{background:#0fb7a5;color:#fff;padding:14px;text-align:center;font-weight:700}
.container{padding:12px}
.card{background:#fff;padding:12px;margin-bottom:12px;border-radius:12px}
button{padding:8px 12px;border:none;border-radius:8px;background:#0fb7a5;color:#fff}
input{width:100%;padding:6px}
table{width:100%;border-collapse:collapse;margin-top:8px}
th,td{border:1px solid #ccc;padding:6px;text-align:center;font-size:13px}
.flex{display:flex;gap:8px;flex-wrap:wrap}
.hidden{display:none}
.lock{position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center}
.lock-card{background:#fff;padding:20px;border-radius:12px;width:260px}
.week-btn{background:#e6fffa;color:#0b6d63;border:1px solid #0fb7a5}
</style>
</head>

<body>
<header>RAFI WORKERS</header>

<!-- LOCK -->
<div id="lock" class="lock">
  <div class="lock-card">
    <h3>üîê Enter PIN</h3>
    <input id="pinInput" type="password">
    <button onclick="unlock()">Unlock</button>
    <p id="msg"></p>
  </div>
</div>

<div class="container hidden" id="app">

  <div class="card flex">
    <button onclick="addWeek()">‚ûï Add Week</button>
    <div id="weekButtons" class="flex"></div>
  </div>

  <div id="weekPage" class="hidden"></div>

</div>

<script>
const { jsPDF } = window.jspdf;
const KEY="RAFI_WORKERS_V2";

let db = JSON.parse(localStorage.getItem(KEY)) || {
  pin:"0000",
  weeks:[]
};
let currentWeekIndex=null;

function save(){localStorage.setItem(KEY,JSON.stringify(db));}

/* ---------- LOCK ---------- */
function unlock(){
  if(pinInput.value===db.pin){
    lock.style.display="none";
    app.classList.remove("hidden");
    renderWeekButtons();
  } else msg.textContent="Wrong PIN";
}

/* ---------- WEEKS ---------- */
function addWeek(){
  db.weeks.push({
    start:"",
    workers:[0,0,0,0,0,0]
  });
  save();
  renderWeekButtons();
}

function renderWeekButtons(){
  weekButtons.innerHTML="";
  db.weeks.forEach((_,i)=>{
    weekButtons.innerHTML+=`
      <button class="week-btn" onclick="openWeek(${i})">
        Week ${i+1}
      </button>`;
  });
}

function openWeek(index){
  currentWeekIndex=index;
  renderWeek();
}

function renderWeek(){
  const w=db.weeks[currentWeekIndex];
  const days=["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];
  let rows="", total=0;

  for(let i=0;i<6;i++){
    let dateStr="";
    if(w.start){
      const d=new Date(w.start);
      d.setDate(d.getDate()+i);
      dateStr=d.toISOString().slice(0,10);
    }
    total+=Number(w.workers[i]||0);

    rows+=`
      <tr>
        <td>${i+1}</td>
        <td>${dateStr}</td>
        <td>${days[i]}</td>
        <td>
          <input type="number" value="${w.workers[i]}"
          onchange="updateWorker(${i},this.value)">
        </td>
      </tr>`;
  }

  weekPage.classList.remove("hidden");
  weekPage.innerHTML=`
    <div class="card">
      <h3>Week ${currentWeekIndex+1}</h3>

      <label>Start Date (Monday)</label>
      <input type="date" value="${w.start}" onchange="setStart(this.value)">

      <table>
        <tr><th>S.No</th><th>Date</th><th>Day</th><th>No. of Workers</th></tr>
        ${rows}
      </table>

      <p><b>Total Workers:</b> ${total}</p>

      <div class="flex">
        <button onclick="saveWeek()">üíæ Save</button>
        <button onclick="downloadPDF()">‚¨á PDF</button>
      </div>
    </div>`;
}

function setStart(v){
  db.weeks[currentWeekIndex].start=v;
  save(); renderWeek();
}
function updateWorker(i,v){
  db.weeks[currentWeekIndex].workers[i]=Number(v||0);
  save(); renderWeek();
}
function saveWeek(){
  save();
  alert("Week saved");
}

/* ---------- PDF ---------- */
function downloadPDF(){
  const w=db.weeks[currentWeekIndex];
  const days=["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];
  const doc=new jsPDF();

  doc.text("RAFI WORKERS ‚Äì Week "+(currentWeekIndex+1),10,10);

  let body=[], total=0;
  for(let i=0;i<6;i++){
    const d=new Date(w.start);
    d.setDate(d.getDate()+i);
    total+=Number(w.workers[i]||0);
    body.push([i+1,d.toISOString().slice(0,10),days[i],w.workers[i]]);
  }

  doc.autoTable({
    startY:20,
    head:[["S.No","Date","Day","Workers"]],
    body
  });

  doc.text("Total Workers: "+total,14,doc.lastAutoTable.finalY+10);
  window.open(doc.output("bloburl"),"_blank");
}
</script>
</body>
</html>
